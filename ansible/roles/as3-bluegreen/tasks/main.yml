# Create or update Application Service and BlueGreen iRule and configuration in one declaration

- name: Create iRuleName variable
  set_fact:
    iRuleName: "{{partition}}_bluegreen_irule"

- name: Create dataGroup variable
  set_fact:
    dataGroup: "{{partition}}_bluegreen_datagroup"

- name: Create tmp directory
  file:
    path: "{{role_path}}/files/tmp/"
    state: directory

- name: Transform iRule template
  template: src="{{role_path}}/files/bluegreen-irule-template.tcl" dest="{{role_path}}/files/tmp/{{partition}}_irule.tcl"

- name: Base64 encode iRule
  shell: cat {{role_path}}/files/tmp/{{partition}}_irule.tcl
  register: iRuleResult

- name: Assign iRule to variable
  set_fact:
    iRuleResultB64: "{{ iRuleResult.stdout | b64encode }}"

- name: Get BIG-IP Authentication Token from {{deviceName1}}
  delegate_to: localhost
  uri:
    body: '{"username":"{{BIGIPadminUsername}}","password":"{{BIGIPadminPassword}}","loginProviderName":"tmos"}'
    body_format: json
    method: POST
    url: "https://{{deviceName1}}/mgmt/shared/authn/login"
    status_code: 200
    validate_certs: no
  register: bigip1_auth_response
  retries: 30
  delay: 5
  until: "(bigip1_auth_response | success) and (bigip1_auth_response.status == 200)"

- name: Assign Auth Token to Variable
  set_fact:
    bigip1_auth_token: "{{bigip1_auth_response.json.token.token}}"

- name: Prepare the AS3 declaration
  template: src="{{role_path}}/files/as3-bluegreen-declaration.json" dest="{{role_path}}/files/tmp/{{partition}}_declaration.json"
  delegate_to: localhost

- name: Validate {{deviceName1}} AS3 Rest Worker is ready
  delegate_to: localhost
  uri:
    headers:
      X-F5-Auth-Token: "{{bigip1_auth_token}}"
    method: GET
    url: "https://{{deviceName1}}/mgmt/shared/appsvcs/available"
    validate_certs: no
  retries: 30
  delay: 5
  register: result
  until: "(result | success) and (result.status == 200)"

- name: Create or update HTTP services in one declaration
  delegate_to: localhost
  uri:
    body: "{{ lookup('file','{{role_path}}/files/tmp/' + '{{partition}}_declaration.json') }}"
    body_format: json
    headers:
      X-F5-Auth-Token: "{{bigip1_auth_token}}"
    method: POST
    status_code: 200
    url: "https://{{deviceName1}}/mgmt/shared/appsvcs/declare"
    validate_certs: no